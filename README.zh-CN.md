# Linux ç½‘å¡æ€§èƒ½ä¼˜åŒ–è„šæœ¬

[![GitHub ä»“åº“](https://img.shields.io/badge/GitHub-SteamedFish%2Fnetwork--adjust-blue?logo=github)](https://github.com/SteamedFish/network-adjust)
[![è®¸å¯è¯: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

ä¸€ä¸ªå¼ºå¤§çš„ Bash è„šæœ¬ï¼Œç”¨äºä¼˜åŒ– Linux ç‰©ç†ç½‘å¡çš„æ€§èƒ½å‚æ•°ï¼Œæ˜¾è‘—æå‡é«˜ååé‡ç¯å¢ƒä¸‹çš„ç½‘ç»œæ€§èƒ½ã€‚

> âš ï¸ **é‡è¦æç¤ºï¼šæœ¬è„šæœ¬ä»…é€‚ç”¨äºé«˜ååé‡ç½‘ç»œç¯å¢ƒä¸‹çš„ååé‡ä¼˜åŒ–ï¼Œä¸é€‚ç”¨äºæ—¶å»¶æ•æ„Ÿåœºæ™¯ï¼ˆå¦‚é‡‘èäº¤æ˜“ã€å®æ—¶æ¸¸æˆã€VoIPï¼‰ã€‚ç”±äºä½¿ç”¨äº†æ›´å¤§çš„ç¼“å†²åŒºå’Œæ‰¹é‡å¤„ç†ï¼Œè¿™äº›ä¼˜åŒ–å®é™…ä¸Šå¯èƒ½ä¼šå¢åŠ å»¶è¿Ÿã€‚**

> âš ï¸ **å…è´£å£°æ˜ï¼šè¿™æ˜¯å‡ å¹´å‰ç¼–å†™çš„ä¸€ä¸ªè„šæœ¬ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€äº›éæ™®é€‚æ€§çš„é€»è¾‘ã€‚AI å·²ç»ç§»é™¤äº†è¿™äº›éæ™®é€‚æ€§é€»è¾‘ï¼Œä»…ä¿ç•™äº†æ™®é€‚æ€§çš„éƒ¨åˆ†ï¼Œå¹¶å¯¹ä»£ç è¿›è¡Œäº†ä¼˜åŒ–å’Œæ–‡æ¡£ç¼–å†™ã€‚ä½†æ˜¯ï¼Œç”±äºå·¥ä½œå†…å®¹å˜æ›´ï¼Œç›®å‰å·²ç»æ²¡æœ‰æ¡ä»¶å®Œæ•´éªŒè¯è¿™ä¸ªè„šæœ¬é‡Œé¢çš„æ‰€æœ‰é€»è¾‘ã€‚AI å·²ç»å¸®åŠ©åˆ†æäº†ä»£ç é€»è¾‘çš„æ­£ç¡®æ€§ï¼ˆå‚è§ [verification-report.md](verification-report.md)ï¼‰ï¼Œä½†åœ¨ä½ æ‰§è¡Œè¿™ä¸ªè„šæœ¬ä¹‹å‰ï¼Œä»ç„¶è¯·è®¤çœŸé˜…è¯»ä»£ç ï¼Œç¡®ä¿ä½ çŸ¥é“ä»£ç åœ¨åšä»€ä¹ˆï¼Œæ¥é¿å…ä¸å¿…è¦çš„é£é™©å’ŒæŸå¤±ã€‚**

## ç®€ä»‹

`linux_ethernet_optimization.sh` æ˜¯ä¸€ä¸ªç”Ÿäº§çº§è„šæœ¬ï¼Œé€šè¿‡è°ƒæ•´ä»¥ä¸‹å…³é”®ç½‘ç»œå‚æ•°æ¥ä¼˜åŒ– Linux ç½‘å¡æ€§èƒ½ï¼š

- **é˜Ÿåˆ—æ•°é‡ (Queue)**ï¼šä¼˜åŒ–å¤šé˜Ÿåˆ—ç½‘å¡çš„å¹¶è¡Œå¤„ç†èƒ½åŠ›
- **ç¯å½¢ç¼“å†²åŒº (Ringbuffer)**ï¼šå‡å°‘é«˜æµé‡ä¸‹çš„ä¸¢åŒ…
- **IRQ äº²å’Œæ€§ (IRQ Affinity)**ï¼šå‡è¡¡ä¸­æ–­è´Ÿè½½åˆ°å¤šä¸ª CPU æ ¸å¿ƒ
- **RPS (Receive Packet Steering)**ï¼šè½¯ä»¶å±‚é¢çš„æ¥æ”¶åŒ…åˆ†å‘
- **XPS (Transmit Packet Steering)**ï¼šè½¯ä»¶å±‚é¢çš„å‘é€åŒ…åˆ†å‘
- **RFS (Receive Flow Steering)**ï¼šæµçº§åˆ«çš„ CPU äº²å’Œæ€§ï¼ˆé»˜è®¤ç¦ç”¨ï¼‰

### é€‚ç”¨åœºæ™¯

- ğŸš€ é«˜ååé‡ç½‘ç»œç¯å¢ƒï¼ˆæ•°æ®ä¸­å¿ƒã€CDNã€å­˜å‚¨é›†ç¾¤ï¼‰
- ğŸ“¦ å¤§æ‰¹é‡æ•°æ®ä¼ è¾“å·¥ä½œè´Ÿè½½
- ğŸ”§ å¤šé˜Ÿåˆ—ç½‘å¡æ€§èƒ½è°ƒä¼˜
- ğŸ–¥ï¸ å¤šæ ¸æœåŠ¡å™¨ç½‘ç»œä¼˜åŒ–
- ğŸ”„ systemd æœåŠ¡é›†æˆ

### ä¸é€‚ç”¨åœºæ™¯

- âŒ ä½å»¶è¿Ÿåº”ç”¨ï¼ˆé‡‘èäº¤æ˜“ã€å®æ—¶é€šä¿¡ï¼‰
- âŒ æ—¶å»¶æ•æ„Ÿå·¥ä½œè´Ÿè½½ï¼ˆæ¸¸æˆæœåŠ¡å™¨ã€VoIPï¼‰
- âŒ å“åº”æ—¶é—´æ¯”ååé‡æ›´é‡è¦çš„åœºæ™¯

## NUMA æ„ŸçŸ¥ç‰ˆæœ¬ï¼ˆå®éªŒæ€§ï¼‰

NUMA æ„ŸçŸ¥ç‰ˆæœ¬å¯ç”¨ï¼š`linux_ethernet_optimization_numa.sh`ã€‚

**âš ï¸ è­¦å‘Šï¼šæ­¤ç‰ˆæœ¬å®Œå…¨ç”± AI ç”Ÿæˆï¼Œæœªç»ç”Ÿäº§ç¯å¢ƒæµ‹è¯•ã€‚**

æ­¤å˜ä½“è‡ªåŠ¨æ£€æµ‹æ¯ä¸ªç½‘å¡çš„ NUMA èŠ‚ç‚¹ï¼Œå¹¶ä»…å°† IRQ/RPS/XPS ç»‘å®šåˆ°è¯¥èŠ‚ç‚¹çš„æœ¬åœ° CPUï¼Œé¿å…è·¨ NUMA èŠ‚ç‚¹å†…å­˜è®¿é—®çš„æ€§èƒ½æŸå¤±ã€‚

**ä¸åŸç‰ˆçš„ä¸»è¦åŒºåˆ«ï¼š**
- ä» `/sys/class/net/<dev>/device/numa_node` è‡ªåŠ¨æ£€æµ‹ç½‘å¡çš„ NUMA èŠ‚ç‚¹
- ä»…å°† IRQ/RPS/XPS ç»‘å®šåˆ°è¯¥ NUMA èŠ‚ç‚¹çš„æœ¬åœ° CPU
- å¦‚æœ NUMA æ£€æµ‹å¤±è´¥ï¼Œè‡ªåŠ¨å›é€€åˆ°åŸå§‹çš„è½®è¯¢è¡Œä¸º
- è¯¦ç»†çš„è­¦å‘Šä¿¡æ¯ã€æµ‹è¯•å»ºè®®å’Œå·²çŸ¥é™åˆ¶è¯·æŸ¥çœ‹è„šæœ¬å¤´éƒ¨æ³¨é‡Š

**æ¨èä½¿ç”¨åœºæ™¯ï¼š**
- å¤šè·¯æœåŠ¡å™¨ï¼ˆ2+ CPUï¼Œå…·æœ‰ç‹¬ç«‹çš„ NUMA åŸŸï¼‰
- NIC NUMA å±€éƒ¨æ€§å¯¹æ€§èƒ½å½±å“æ˜¾è‘—çš„ç³»ç»Ÿ
- èƒ½å¤Ÿåœ¨ç”Ÿäº§éƒ¨ç½²å‰è¿›è¡Œå……åˆ†æµ‹è¯•çš„ç”¨æˆ·

**ä¸æ¨èä½¿ç”¨åœºæ™¯ï¼š**
- å•è·¯ç³»ç»Ÿï¼ˆæ—  NUMA ä¼˜åŠ¿ï¼‰
- æœªç»å……åˆ†æµ‹è¯•çš„ç”Ÿäº§ç¯å¢ƒ
- ä¸ç†Ÿæ‚‰ NUMA æ‹“æ‰‘çš„ç”¨æˆ·

è¯¦ç»†çš„æµ‹è¯•æ­¥éª¤å’Œå·²çŸ¥é™åˆ¶è¯·å‚è€ƒè„šæœ¬å¤´éƒ¨æ³¨é‡Šã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. é˜Ÿåˆ—ä¼˜åŒ– (Queue)

**åŸç†**ï¼šå¤šé˜Ÿåˆ—ç½‘å¡æ”¯æŒå°†ç½‘ç»œæµé‡åˆ†é…åˆ°å¤šä¸ªç¡¬ä»¶é˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—å¯ä»¥ç‹¬ç«‹å¤„ç†ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPUã€‚

**ç›®æ ‡å€¼**ï¼š`min(CPU æ ¸å¿ƒæ•°, ç½‘å¡æœ€å¤§é˜Ÿåˆ—æ•°)`

**æ•ˆæœ**ï¼š
- æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›
- å‡å°‘å•æ ¸ç“¶é¢ˆ
- æå‡æ•´ä½“ååé‡

```bash
# ç¤ºä¾‹ï¼š8 æ ¸ CPUï¼Œç½‘å¡æ”¯æŒ 16 é˜Ÿåˆ— â†’ è®¾ç½®ä¸º 8 é˜Ÿåˆ—
```

### 2. ç¯å½¢ç¼“å†²åŒºä¼˜åŒ– (Ringbuffer)

**åŸç†**ï¼šRingbuffer æ˜¯ç½‘å¡å’Œå†…æ ¸ä¹‹é—´çš„æ•°æ®ç¼“å†²åŒºï¼Œæ›´å¤§çš„ç¼“å†²åŒºå¯ä»¥åœ¨æµé‡çªå‘æ—¶å‡å°‘ä¸¢åŒ…ã€‚

**ç›®æ ‡å€¼**ï¼šç¡¬ä»¶æ”¯æŒçš„æœ€å¤§å€¼ï¼ˆRX å’Œ TXï¼‰

**æ•ˆæœ**ï¼š
- é™ä½ä¸¢åŒ…ç‡ï¼ˆç‰¹åˆ«æ˜¯çªå‘æµé‡ï¼‰
- æé«˜ç¨³å®šæ€§
- é€‚åº”æµé‡æ³¢åŠ¨

### 3. IRQ äº²å’Œæ€§ä¼˜åŒ– (IRQ Affinity)

**åŸç†**ï¼šå°†ç½‘å¡çš„ä¸­æ–­è¯·æ±‚ï¼ˆIRQï¼‰åˆ†æ•£åˆ°ä¸åŒçš„ CPU æ ¸å¿ƒ,é¿å…å•æ ¸è¿‡è½½ã€‚

**ç­–ç•¥**ï¼šè½®è¯¢åˆ†é…ï¼ˆround-robinï¼‰

**æ•ˆæœ**ï¼š
- å‡è¡¡ CPU è´Ÿè½½
- é¿å…ä¸­æ–­å¤„ç†ç“¶é¢ˆ
- æå‡ä¸­æ–­å“åº”é€Ÿåº¦

**âš ï¸ NUMA é™åˆ¶**ï¼šè¯¦è§"å·²çŸ¥é™åˆ¶"ç« èŠ‚ - IRQã€RPSã€XPS ä¼˜åŒ–å‡æœªè€ƒè™‘ NUMA æ‹“æ‰‘ç»“æ„ã€‚

### 4. RPS ä¼˜åŒ– (Receive Packet Steering)

**åŸç†**ï¼šåœ¨è½¯ä»¶å±‚é¢å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…åˆ†å‘åˆ°å¤šä¸ª CPUï¼Œå¼¥è¡¥ç¡¬ä»¶é˜Ÿåˆ—ä¸è¶³ã€‚

**å¯ç”¨æ¡ä»¶**ï¼š
- âœ… é˜Ÿåˆ—æ•° < CPU æ ¸å¿ƒæ•° â†’ å¯ç”¨ RPS
- âŒ é˜Ÿåˆ—æ•° â‰¥ CPU æ ¸å¿ƒæ•° â†’ ç¦ç”¨ RPSï¼ˆç¡¬ä»¶å·²è¶³å¤Ÿåˆ†æ•£ï¼‰

**æ•ˆæœ**ï¼š
- æé«˜æ¥æ”¶ç«¯å¹¶è¡Œåº¦
- å……åˆ†åˆ©ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
- å‡å°‘ CPU ç©ºé—²æµªè´¹

**âš ï¸ NUMA é™åˆ¶**ï¼šè¯¦è§"æ³¨æ„äº‹é¡¹"ç« èŠ‚ - RPS ä½¿ç”¨æ‰€æœ‰ CPU,ä¸è€ƒè™‘ NUMA æ‹“æ‰‘ã€‚

### 5. XPS ä¼˜åŒ– (Transmit Packet Steering)

**åŸç†**ï¼šä¸ RPS ç±»ä¼¼ï¼Œä½†é’ˆå¯¹å‘é€ç«¯ã€‚

**æ•ˆæœ**ï¼š
- æé«˜å‘é€ç«¯å¹¶è¡Œåº¦
- ä¼˜åŒ– cache å±€éƒ¨æ€§

**âš ï¸ NUMA é™åˆ¶**ï¼šè¯¦è§"æ³¨æ„äº‹é¡¹"ç« èŠ‚ - XPS ä½¿ç”¨æ‰€æœ‰ CPU,ä¸è€ƒè™‘ NUMA æ‹“æ‰‘ã€‚

### 6. RFS ä¼˜åŒ– (Receive Flow Steering)

**âš ï¸ é»˜è®¤ç¦ç”¨ - ç”Ÿäº§ç¯å¢ƒé£é™©**

**ç¦ç”¨åŸå› **ï¼š
1. **Hash ç¢°æ’é—®é¢˜**ï¼šRFS ä½¿ç”¨ hash è¡¨ï¼Œç¢°æ’ä¼šå¯¼è‡´ `ksoftirq` CPU ä½¿ç”¨ç‡é£™å‡è‡³ 100%
2. **å›ºä»¶ Bug**ï¼šæŸäº›ç½‘å¡å›ºä»¶å­˜åœ¨ RFS ç›¸å…³çš„éšæœºæ•…éšœ
3. **å»¶è¿Ÿæ³¢åŠ¨**ï¼šå¯èƒ½å¼•å…¥ä¸å¯é¢„æµ‹çš„ ping å»¶è¿ŸæŠ–åŠ¨

**ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼šé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚å¹¶å……åˆ†æµ‹è¯•ï¼Œå¦åˆ™ä¿æŒç¦ç”¨ã€‚

```bash
# å¦‚æœç¡®å®éœ€è¦å¯ç”¨ï¼ˆé£é™©è‡ªè´Ÿï¼‰
./linux_ethernet_optimization.sh -y -a rfs
```

## ç³»ç»Ÿè¦æ±‚

### ä¾èµ–é¡¹

**å¿…éœ€ä¾èµ–**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
command -v ethtool lspci bash grep sed column

# Debian/Ubuntu å®‰è£…
apt-get install ethtool pciutils bash grep sed coreutils

# CentOS/RHEL å®‰è£…
yum install ethtool pciutils bash grep sed coreutils
```

**å¯é€‰ä¾èµ–ï¼ˆä»… CPU > 64 æ ¸å¿ƒæ—¶éœ€è¦ï¼‰**ï¼š
- `bc` ï¼ˆæ¨èï¼Œæ•°å­¦è®¡ç®—ï¼‰
- `python3` ï¼ˆfallbackï¼‰
- `calc` ï¼ˆæœ€å fallbackï¼‰

### æƒé™è¦æ±‚

- **å¿…é¡»ä»¥ root èº«ä»½è¿è¡Œ**ï¼ˆéœ€è¦ä¿®æ”¹ `/sys` å’Œ `/proc` æ–‡ä»¶ï¼‰
- éœ€è¦ç‰©ç†ç½‘å¡ï¼ˆè™šæ‹Ÿç½‘å¡å’Œè™šæ‹ŸåŒ–é©±åŠ¨ä¼šè¢«è‡ªåŠ¨æ’é™¤ï¼‰

### å…¼å®¹æ€§

- **Bash ç‰ˆæœ¬**: >= 4.0
- **å†…æ ¸ç‰ˆæœ¬**: >= 2.6.35ï¼ˆæ”¯æŒ RPS/RFS ç‰¹æ€§ï¼‰
- **GNU sed**: å¿…é¡»ï¼ˆBSD sed ä¸å…¼å®¹ï¼‰

## å®‰è£…

### ä¸‹è½½è„šæœ¬

```bash
# æ–¹å¼ 1ï¼šå…‹éš†ä»“åº“
git clone <repository-url>
cd network-adjust

# æ–¹å¼ 2ï¼šç›´æ¥ä¸‹è½½å•æ–‡ä»¶
wget https://raw.githubusercontent.com/<user>/<repo>/main/linux_ethernet_optimization.sh
chmod +x linux_ethernet_optimization.sh
```

### éªŒè¯ä¾èµ–

```bash
# è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥ä¾èµ–ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨éªŒè¯
./linux_ethernet_optimization.sh -n
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

#### 1. å¹²è¿è¡Œï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰

```bash
# ä»…æ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œï¼Œä¸å®é™…ä¿®æ”¹
sudo ./linux_ethernet_optimization.sh -n
```

#### 2. äº¤äº’å¼ä¼˜åŒ–

```bash
# æ˜¾ç¤ºæ“ä½œï¼Œå¹¶è¯¢é—®æ˜¯å¦ç»§ç»­
sudo ./linux_ethernet_optimization.sh
```

#### 3. è‡ªåŠ¨ä¼˜åŒ–ï¼ˆæ— äº¤äº’ï¼‰

```bash
# è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰ä¼˜åŒ–ï¼Œä¸è¯¢é—®
sudo ./linux_ethernet_optimization.sh -y
```

### å‘½ä»¤è¡Œé€‰é¡¹è¯¦è§£

#### æ‰§è¡Œæ¨¡å¼

| é€‰é¡¹ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| `-n` | å¹²è¿è¡Œæ¨¡å¼ï¼ˆä»…æ˜¾ç¤ºï¼Œä¸æ‰§è¡Œï¼‰ | `sudo ./script.sh -n` |
| `-y` | è‡ªåŠ¨ç¡®è®¤æ¨¡å¼ï¼ˆè·³è¿‡äº¤äº’æç¤ºï¼‰ | `sudo ./script.sh -y` |

#### ä¼˜åŒ–é¡¹æ§åˆ¶

| é€‰é¡¹ | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|
| `-a <action>` | **åŒ…å«**æŒ‡å®šçš„ä¼˜åŒ–é¡¹ | `-a queue -a ringbuffer` |
| `-A <action>` | **æ’é™¤**æŒ‡å®šçš„ä¼˜åŒ–é¡¹ | `-A rfs` |

**å¯ç”¨çš„ action å€¼**ï¼š
- `queue` - é˜Ÿåˆ—æ•°é‡ä¼˜åŒ–
- `ringbuffer` - ç¯å½¢ç¼“å†²åŒºä¼˜åŒ–
- `irq` - IRQ äº²å’Œæ€§ä¼˜åŒ–
- `rps` - RPS ä¼˜åŒ–
- `xps` - XPS ä¼˜åŒ–
- `rfs` - RFS ä¼˜åŒ–ï¼ˆé»˜è®¤å·²æ’é™¤ï¼‰

#### ç½‘å¡è¿‡æ»¤ï¼ˆæŒ‰ç³»ç»Ÿåç§°ï¼‰

| é€‰é¡¹ | è¯´æ˜ | åŒ¹é…è§„åˆ™ | ç¤ºä¾‹ |
|-----|------|---------|------|
| `-e <name>` | **åŒ…å«**æŒ‡å®šç½‘å¡ | ç²¾ç¡®åŒ¹é… | `-e enp4s0` |
| `-E <name>` | **æ’é™¤**æŒ‡å®šç½‘å¡ | ç²¾ç¡®åŒ¹é… | `-E enp4s0` |

#### ç½‘å¡è¿‡æ»¤ï¼ˆæŒ‰ç¡¬ä»¶è®¾å¤‡åï¼‰

| é€‰é¡¹ | è¯´æ˜ | åŒ¹é…è§„åˆ™ | ç¤ºä¾‹ |
|-----|------|---------|------|
| `-i <device>` | **åŒ…å«**è®¾å¤‡å | éƒ¨åˆ†åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™ | `-i X722` |
| `-I <device>` | **æ’é™¤**è®¾å¤‡å | éƒ¨åˆ†åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™ | `-I X710` |

#### ç½‘å¡è¿‡æ»¤ï¼ˆæŒ‰é©±åŠ¨ï¼‰

| é€‰é¡¹ | è¯´æ˜ | åŒ¹é…è§„åˆ™ | ç¤ºä¾‹ |
|-----|------|---------|------|
| `-d <driver>` | **åŒ…å«**é©±åŠ¨ | ç²¾ç¡®åŒ¹é… | `-d i40e` |
| `-D <driver>` | **æ’é™¤**é©±åŠ¨ | ç²¾ç¡®åŒ¹é… | `-D ixgbe` |

#### ç½‘å¡è¿‡æ»¤ï¼ˆæŒ‰å‚å•†ï¼‰

| é€‰é¡¹ | è¯´æ˜ | åŒ¹é…è§„åˆ™ | ç¤ºä¾‹ |
|-----|------|---------|------|
| `-v <vendor>` | **åŒ…å«**å‚å•† | éƒ¨åˆ†åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™ | `-v Intel` |
| `-V <vendor>` | **æ’é™¤**å‚å•† | éƒ¨åˆ†åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™ | `-V Broadcom` |

### ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šä»…ä¼˜åŒ–é˜Ÿåˆ—å’Œ Ringbuffer

```bash
sudo ./linux_ethernet_optimization.sh -y -a queue -a ringbuffer
```

#### ç¤ºä¾‹ 2ï¼šä¼˜åŒ–æ‰€æœ‰ Intel ç½‘å¡

```bash
sudo ./linux_ethernet_optimization.sh -y -v Intel
```

#### ç¤ºä¾‹ 3ï¼šä¼˜åŒ–é™¤ i40e é©±åŠ¨å¤–çš„æ‰€æœ‰ç½‘å¡

```bash
sudo ./linux_ethernet_optimization.sh -y -D i40e
```

#### ç¤ºä¾‹ 4ï¼šä»…ä¼˜åŒ– enp4s0 ç½‘å¡ï¼Œä¸ä¼˜åŒ– RFS

```bash
sudo ./linux_ethernet_optimization.sh -y -e enp4s0 -A rfs
```

#### ç¤ºä¾‹ 5ï¼šä¼˜åŒ– Intel å’Œ Broadcom ç½‘å¡ï¼Œæ’é™¤ ixgbe é©±åŠ¨

```bash
sudo ./linux_ethernet_optimization.sh -y -v Intel -v Broadcom -D ixgbe
```

## systemd é›†æˆ

### ä¸€æ¬¡æ€§è¿è¡Œï¼ˆä¸´æ—¶ä¼˜åŒ–ï¼‰

```bash
# ä½¿ç”¨ systemd-run åœ¨å¯åŠ¨æ—¶æ‰§è¡Œ
systemd-run --on-boot=5s /path/to/linux_ethernet_optimization.sh -y
```

### æŒä¹…åŒ–é…ç½®ï¼ˆæ¨èï¼‰

åˆ›å»º systemd service æ–‡ä»¶ï¼š

```bash
# åˆ›å»ºæœåŠ¡æ–‡ä»¶
sudo nano /etc/systemd/system/network-optimization.service
```

```ini
[Unit]
Description=Optimize Ethernet Card Performance
After=network-pre.target
Before=network.target
Wants=network-pre.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/linux_ethernet_optimization.sh -y
RemainAfterExit=yes
StandardOutput=journal
StandardError=journal

# è®¾ç½®ç¯å¢ƒå˜é‡æ ‡è¯† systemd å¯åŠ¨ï¼ˆå¯é€‰ï¼‰
Environment="LAUNCHED_BY_SYSTEMD=1"

[Install]
WantedBy=multi-user.target
```

å¯ç”¨æœåŠ¡ï¼š

```bash
# å¤åˆ¶è„šæœ¬åˆ°ç³»ç»Ÿè·¯å¾„
sudo cp linux_ethernet_optimization.sh /usr/local/bin/
sudo chmod +x /usr/local/bin/linux_ethernet_optimization.sh

# é‡è½½ systemd é…ç½®
sudo systemctl daemon-reload

# å¯ç”¨æœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰
sudo systemctl enable network-optimization.service

# ç«‹å³è¿è¡Œ
sudo systemctl start network-optimization.service

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status network-optimization.service
```

### systemd-networkd æ›¿ä»£æ–¹æ¡ˆ

å¯¹äºä½¿ç”¨ systemd-networkd çš„ç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡ `.link` æ–‡ä»¶æŒä¹…åŒ–éƒ¨åˆ†é…ç½®ï¼š

```bash
# åˆ›å»º link æ–‡ä»¶
sudo nano /etc/systemd/network/10-eth.link
```

```ini
[Match]
MACAddress=xx:xx:xx:xx:xx:xx

[Link]
# è®¾ç½® Ringbuffer å¤§å°ï¼ˆsystemd v246+ï¼‰
RxBufferSize=max
TxBufferSize=max

# è®¾ç½®é˜Ÿåˆ—æ•°é‡ä¸ºæœ€å¤§å€¼ï¼ˆsystemd v246+ï¼‰
RxChannels=max
TxChannels=max
CombinedChannels=max
# OtherChannels=max  # å¦‚éœ€è¦å¯å–æ¶ˆæ³¨é‡Š
```

**æ³¨æ„**ï¼š`.link` æ–‡ä»¶åªèƒ½é…ç½®éƒ¨åˆ†å‚æ•°ï¼ŒIRQ/RPS/XPS ç­‰ä»éœ€è„šæœ¬è®¾ç½®ã€‚

## ä½œä¸ºåº“ä½¿ç”¨ï¼ˆsourceï¼‰

è„šæœ¬å¯ä»¥è¢«å…¶ä»–è„šæœ¬ sourceï¼Œç›´æ¥è°ƒç”¨å†…éƒ¨å‡½æ•°ï¼š

### å¯ç”¨å‡½æ•°åˆ—è¡¨

#### ä¼˜åŒ–å‡½æ•°

```bash
# RPS ä¼˜åŒ–
set_ethernet_rps_to_optimum <ç½‘å¡å>

# XPS ä¼˜åŒ–
set_ethernet_xps_to_optimum <ç½‘å¡å>

# é˜Ÿåˆ—æ•°é‡ä¼˜åŒ–
set_ethernet_queue_to_optimum <ç½‘å¡å>

# Ringbuffer ä¼˜åŒ–
set_ethernet_ringbuffer_to_optimum <ç½‘å¡å>

# IRQ äº²å’Œæ€§ä¼˜åŒ–
set_ethernet_irq_affinity_to_optimum <ç½‘å¡å>

# RFS ä¼˜åŒ–ï¼ˆæ…ç”¨ï¼‰
set_ethernet_rfs_to_optimum <ç½‘å¡å>
```

#### æ£€æŸ¥å‡½æ•°

```bash
# æ£€æŸ¥ RPS çŠ¶æ€
check_ethernet_rps <ç½‘å¡å>

# æ£€æŸ¥ XPS çŠ¶æ€
check_ethernet_xps <ç½‘å¡å>

# æ£€æŸ¥é˜Ÿåˆ—é…ç½®
check_ethernet_queue <ç½‘å¡å>

# æ£€æŸ¥ Ringbuffer é…ç½®
check_ethernet_ringbuffer <ç½‘å¡å>

# æ£€æŸ¥ IRQ äº²å’Œæ€§
check_ethernet_irq_affinity <ç½‘å¡å>

# æ£€æŸ¥ RFS é…ç½®
check_ethernet_rfs <ç½‘å¡å>
```

#### æŸ¥è¯¢å‡½æ•°

```bash
# è·å–ç½‘å¡çš„ç¡¬ä»¶é˜Ÿåˆ—æ•°
get_ethernet_hardware_queues_number <ç½‘å¡å>

# è·å–ç½‘å¡çš„å†…æ ¸é˜Ÿåˆ—æ•°
get_ethernet_kernel_queues_number <ç½‘å¡å>

# è·å–ç‰©ç†ç½‘å¡åˆ—è¡¨
get_physical_ethernet_card_list

# ç”Ÿæˆ CPU maskï¼ˆæ‰€æœ‰ CPUï¼‰
generate_cpus_mask <CPU æ•°é‡>
```

### ä½¿ç”¨ç¤ºä¾‹

```bash
#!/bin/bash
# è‡ªå®šä¹‰ä¼˜åŒ–è„šæœ¬

# åŠ è½½å‡½æ•°åº“
source /path/to/linux_ethernet_optimization.sh

# ä»…ä¼˜åŒ– eth0 çš„ RPS å’Œ XPS
set_ethernet_rps_to_optimum eth0
set_ethernet_xps_to_optimum eth0

# æ£€æŸ¥ä¼˜åŒ–ç»“æœ
check_ethernet_rps eth0
check_ethernet_xps eth0

echo "ä¼˜åŒ–å®Œæˆ"
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é”™è¯¯

#### 1. "ERROR: you need root permission"

**åŸå› **ï¼šè„šæœ¬éœ€è¦ root æƒé™ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶ã€‚

**è§£å†³**ï¼š
```bash
sudo ./linux_ethernet_optimization.sh -y
```

#### 2. "ERROR: you need <command> command to run the script"

**åŸå› **ï¼šç¼ºå°‘å¿…éœ€çš„ç³»ç»Ÿå‘½ä»¤ã€‚

**è§£å†³**ï¼š
```bash
# Debian/Ubuntu
sudo apt-get install ethtool pciutils

# CentOS/RHEL
sudo yum install ethtool pciutils
```

#### 3. "ERROR: you need GNU version of sed"

**åŸå› **ï¼šç³»ç»Ÿä½¿ç”¨çš„æ˜¯ BSD sedï¼ˆå¸¸è§äº macOSï¼‰ã€‚

**è§£å†³**ï¼š
```bash
# macOS å®‰è£… GNU sed
brew install gnu-sed
# ä½¿ç”¨ gsed ä»£æ›¿ sed
```

#### 4. ç½‘å¡çŸ­æš‚æ–­ç½‘

**åŸå› **ï¼šä¿®æ”¹ç½‘å¡å‚æ•°éœ€è¦é‡ç½®ç½‘å¡ï¼Œä¼šå¯¼è‡´ 500ms-30s çš„çŸ­æš‚æ–­ç½‘ã€‚

**è§£å†³**ï¼š
- æ­£å¸¸ç°è±¡ï¼Œç­‰å¾…å³å¯
- bonding åœºæ™¯è„šæœ¬ä¼šè‡ªåŠ¨å»¶è¿Ÿ 10 ç§’é¿å…åŒç½‘å¡åŒæ—¶é‡ç½®
- åœ¨ç»´æŠ¤çª—å£æ‰§è¡Œï¼Œé¿å…å½±å“ä¸šåŠ¡

### éªŒè¯ä¼˜åŒ–æ•ˆæœ

#### 1. æŸ¥çœ‹é˜Ÿåˆ—æ•°é‡

```bash
ethtool -l eth0
```

#### 2. æŸ¥çœ‹ Ringbuffer å¤§å°

```bash
ethtool -g eth0
```

#### 3. æŸ¥çœ‹ IRQ äº²å’Œæ€§

```bash
grep eth0 /proc/interrupts
cat /proc/irq/*/smp_affinity_list
```

#### 4. æŸ¥çœ‹ RPS/XPS é…ç½®

```bash
cat /sys/class/net/eth0/queues/rx-0/rps_cpus
cat /sys/class/net/eth0/queues/tx-0/xps_cpus
```

#### 5. æ€§èƒ½æµ‹è¯•

```bash
# ä½¿ç”¨ iperf3 æµ‹è¯•ååé‡
iperf3 -c <server> -P 8

# ä½¿ç”¨ netperf æµ‹è¯•å»¶è¿Ÿ
netperf -H <server> -t TCP_RR
```

### å¦‚ä½•å›æ»šé…ç½®

ä¼˜åŒ–é…ç½®åœ¨**é‡å¯åä¼šä¸¢å¤±**ï¼Œå¦‚æœéœ€è¦ç«‹å³å›æ»šï¼š

```bash
# æ–¹å¼ 1ï¼šé‡å¯ç½‘å¡
sudo ifdown eth0 && sudo ifup eth0

# æ–¹å¼ 2ï¼šé‡å¯ç³»ç»Ÿ
sudo reboot

# æ–¹å¼ 3ï¼šæ‰‹åŠ¨æ¢å¤é»˜è®¤å€¼
# RPS ç¦ç”¨
echo 0 | sudo tee /sys/class/net/eth0/queues/rx-*/rps_cpus

# XPS ç¦ç”¨
echo 0 | sudo tee /sys/class/net/eth0/queues/tx-*/xps_cpus

# é˜Ÿåˆ—æ•°æ¢å¤é»˜è®¤ï¼ˆéœ€ ethtoolï¼‰
sudo ethtool -L eth0 combined <åŸå§‹é˜Ÿåˆ—æ•°>
```

## æ³¨æ„äº‹é¡¹

### âš ï¸ é‡è¦è­¦å‘Š

1. **ç½‘å¡é‡ç½®é£é™©**
   - ä¿®æ”¹å‚æ•°ä¼šå¯¼è‡´ç½‘å¡çŸ­æš‚é‡ç½®
   - æ–­ç½‘æ—¶é—´ï¼š500ms ~ 30 ç§’ï¼ˆå–å†³äºç½‘å¡å‹å·ï¼‰
   - å»ºè®®åœ¨ç»´æŠ¤çª—å£æ‰§è¡Œ

2. **bonding åœºæ™¯å»¶è¿Ÿ**
   - è„šæœ¬åœ¨å¤„ç†å¤šä¸ªç½‘å¡æ—¶ï¼Œæ¯ä¸ªç½‘å¡ä¹‹é—´ä¼šå»¶è¿Ÿ 10 ç§’
   - é˜²æ­¢ bonding åŒå£åŒæ—¶é‡ç½®å¯¼è‡´æ›´é•¿çš„æ–­ç½‘
   - systemd å¯åŠ¨åœºæ™¯ä¼šè·³è¿‡å»¶è¿Ÿï¼ˆboot-time ä¼˜åŒ–ï¼‰

3. **é…ç½®æŒä¹…åŒ–é—®é¢˜**
   - **ä¼˜åŒ–é…ç½®ä¸ä¼šåœ¨é‡å¯åè‡ªåŠ¨æ¢å¤**
   - å¿…é¡»é€šè¿‡ systemd service æˆ– cron å®ç°æŒä¹…åŒ–
   - æˆ–ä½¿ç”¨ systemd-networkd çš„ `.link` æ–‡ä»¶ï¼ˆéƒ¨åˆ†å‚æ•°ï¼‰

4. **è™šæ‹Ÿç½‘å¡å…¼å®¹æ€§**
   - è„šæœ¬è®¾è®¡ç”¨äºç‰©ç†ç½‘å¡
   - è™šæ‹Ÿç½‘å¡ï¼ˆvethã€bridgeã€tun/tapï¼‰ä¼šè¢«è‡ªåŠ¨æ’é™¤
   - è™šæ‹ŸåŒ–é©±åŠ¨ï¼ˆvirtio_netã€vmxnet3ã€xen-netfrontã€hv_netvscï¼‰ä¼šè¢«è‡ªåŠ¨æ’é™¤

5. **RFS é»˜è®¤ç¦ç”¨**
   - **ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®ä¿æŒç¦ç”¨**
   - å¯ç”¨å‰å¿…é¡»å……åˆ†æµ‹è¯•,ç¡®è®¤æ—  hash ç¢°æ’å’Œå›ºä»¶ bug
   - è¯¦è§"åŠŸèƒ½ç‰¹æ€§"ç« èŠ‚çš„ RFS è¯´æ˜

6. **æœªè€ƒè™‘ NUMA äº²å’Œæ€§** âš ï¸
   - **å¤šè·¯æœåŠ¡å™¨ä¸Šçš„å…³é”®é™åˆ¶**
   - **å—å½±å“çš„ä¼˜åŒ–é¡¹**ï¼šIRQ äº²å’Œæ€§ã€RPSã€XPSï¼ˆå‡ä½¿ç”¨è½®è¯¢æ–¹å¼å°†å·¥ä½œåˆ†é…åˆ°æ‰€æœ‰ CPUï¼‰
   - **ä¸å°Šé‡ NUMA èŠ‚ç‚¹è¾¹ç•Œ**
   - **å½±å“**ï¼šåœ¨ NUMA ç³»ç»Ÿä¸Š,ç½‘ç»œå¤„ç†å¯èƒ½å‘ç”Ÿåœ¨è¿œç¨‹ CPU ä¸Š,å¯¼è‡´ï¼š
     - å†…å­˜è®¿é—®å»¶è¿Ÿå¢åŠ  2-3 å€
     - è·¨èŠ‚ç‚¹æµé‡å¯¼è‡´ååé‡ä¸‹é™
     - ç¼“å­˜æ•ˆç‡ä½ä¸‹,CPU å¼€é”€å¢åŠ 
   - **å—å½±å“ç³»ç»Ÿ**ï¼šå¤šè·¯æœåŠ¡å™¨(2+ CPU),AMD EPYCã€Intel Xeon å¤šè·¯é…ç½®,ä»»ä½•å…·æœ‰å¤šä¸ª NUMA èŠ‚ç‚¹çš„ç³»ç»Ÿ
   - **ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**ï¼šæ‰‹åŠ¨æ£€æŸ¥ç½‘å¡çš„ NUMA èŠ‚ç‚¹å¹¶å°† IRQ/RPS/XPS ç»‘å®šåˆ°æœ¬åœ° CPUï¼š
     ```bash
     # æ£€æŸ¥ç½‘å¡çš„ NUMA èŠ‚ç‚¹
     cat /sys/class/net/eth0/device/numa_node
     # è·å–æœ¬åœ° CPU
     cat /sys/devices/system/node/node0/cpulist
     # ä»…å°† IRQ/RPS/XPS ç»‘å®šåˆ°æœ¬åœ° CPU
     ```
   - **æ¨èæ–¹æ¡ˆ**ï¼šå¯¹äº NUMA ç³»ç»Ÿ,ä½¿ç”¨ NUMA æ„ŸçŸ¥çš„è°ƒä¼˜å·¥å…·ï¼ˆå¦‚ `tuned`ã€`irqbalance --hintpolicy=subset`ï¼‰

### ğŸ’¡ æœ€ä½³å®è·µ

1. **é¦–æ¬¡ä½¿ç”¨å…ˆå¹²è¿è¡Œ**
   ```bash
   sudo ./linux_ethernet_optimization.sh -n
   ```

2. **åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯**
   - å…ˆåœ¨æµ‹è¯•æœåŠ¡å™¨éªŒè¯æ•ˆæœ
   - ç¡®è®¤æ— å¼‚å¸¸åå†åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ

3. **ä½¿ç”¨ systemd æŒä¹…åŒ–**
   - åˆ›å»º systemd service
   - è®¾ç½®å¼€æœºè‡ªå¯

4. **ç›‘æ§ä¼˜åŒ–æ•ˆæœ**
   - ä½¿ç”¨ç›‘æ§å·¥å…·è§‚å¯Ÿ CPU ä½¿ç”¨ç‡ã€ç½‘ç»œååé‡
   - è®°å½•ä¼˜åŒ–å‰åçš„æ€§èƒ½æŒ‡æ ‡

5. **é€æ­¥ä¼˜åŒ–**
   - å¯ä»¥å…ˆä¼˜åŒ–å•ä¸ªå‚æ•°ï¼Œè§‚å¯Ÿæ•ˆæœ
   - ä¾‹å¦‚å…ˆä¼˜åŒ– queue å’Œ ringbufferï¼Œç¡®è®¤ç¨³å®šåå†ä¼˜åŒ–å…¶ä»–

## æŠ€æœ¯ç»†èŠ‚

### CPU Mask è®¡ç®—æ–¹æ³•

**æŒ‘æˆ˜**ï¼šBash æ— æ³•å¤„ç†è¶…è¿‡ 64 ä½çš„æ•´æ•°è¿ç®—ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ†å±‚ fallback ç­–ç•¥
```bash
# CPU â‰¤ 64ï¼šçº¯ Bash ä½è¿ç®—
mask=$((2 ** cpus - 1))
printf "%x" "$mask"

# CPU > 64ï¼šä¾æ¬¡å°è¯•
# 1) bcï¼ˆæœ€å¸¸è§ï¼Œæ¨èï¼‰
echo "obase=16; 2^$cpus - 1" | bc

# 2) python3ï¼ˆfallbackï¼‰
python3 -c "print(hex((2**$cpus)-1)[2:])"

# 3) calcï¼ˆåŸå§‹æ–¹æ¡ˆï¼Œæœ€å fallbackï¼‰
calc "hex(2^$cpus - 1)"
```

**æ ¼å¼åŒ–**ï¼šæ¯ 8 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦æ’å…¥ä¸€ä¸ªé€—å·
```
ç¤ºä¾‹ï¼š256 CPU â†’ ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
æ ¼å¼åŒ–å â†’ ffffffff,ffffffff,ffffffff,ffffffff,ffffffff,ffffffff,ffffffff,ffffffff
```

### mlx5 ç½‘å¡çš„ç‰¹æ®Šå¤„ç†

**é—®é¢˜**ï¼šmlx5e é©±åŠ¨å°†æ™®é€šé˜Ÿåˆ—ä¸ XSK é˜Ÿåˆ—æ··åœ¨ä¸€èµ·æŠ¥å‘Šï¼Œå¯¼è‡´é˜Ÿåˆ—æ•°ç¿»å€ã€‚

**è§£å†³**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶é™¤ä»¥ 2
```bash
get_ethernet_kernel_queues_number() {
    local ETH=$1
    local queues=$(find /sys/class/net/"${ETH}"/queues/ -type d -name "rx-*" | wc -l)
    
    # mlx5 ç‰¹æ®Šå¤„ç†
    local driver=$(basename "$(readlink /sys/class/net/"${ETH}"/device/driver)")
    if [[ "$driver" == "mlx5_core" ]]; then
        queues=$((queues / 2))
    fi
    
    echo "$queues"
}
```

### IRQ é˜Ÿåˆ—å·æå–ç®—æ³•

**å¤§å¤šæ•°é©±åŠ¨**ï¼šIRQ åç§°æ ¼å¼ä¸º `<prefix>-<queue>` æˆ– `<prefix>@<queue>`
```
ä¾‹å¦‚ï¼šeth0-TxRx-0, i40e-eth0@0
æå–ï¼šä½¿ç”¨ sed 's/.*[-@]//'
```

**mlx5 ä¾‹å¤–**ï¼šæ ¼å¼ä¸º `mlx5_comp<queue>@pci:<id>`
```
ä¾‹å¦‚ï¼šmlx5_comp0@pci:0000:04:00.0
æå–ï¼šä½¿ç”¨ sed 's/mlx5_comp\([0-9]*\)@.*/\1/'
```

### è®¾è®¡ç‰¹ç‚¹

æœ¬è„šæœ¬é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **ä»£ç ç»„ç»‡æ¸…æ™°**
   - ä½¿ç”¨ `_sysfs_read()` / `_sysfs_write()` ç»Ÿä¸€ sysfs æ“ä½œ
   - ä½¿ç”¨ `_ethtool_parse()` ç»Ÿä¸€ ethtool è§£æé€»è¾‘
   - ä½¿ç”¨ `_filter_list()` å¤„ç†è¿‡æ»¤é€»è¾‘
   - ä¸»å¾ªç¯é€»è¾‘ç®€æ´æ˜äº†

2. **ä¾èµ–æœ€å°åŒ–**
   - CPU â‰¤64 æ—¶æ— éœ€å¤–éƒ¨å·¥å…·ï¼Œçº¯ Bash å®ç°ï¼ˆè¦†ç›– 95% åœºæ™¯ï¼‰
   - CPU >64 æ—¶æ”¯æŒ `bc` / `python3` / `calc` ä¸‰ç§è®¡ç®—å·¥å…·çš„è‡ªåŠ¨å›é€€

3. **å¯è¯»æ€§ä¼˜å…ˆ**
   - é’ˆå¯¹å¤æ‚é€»è¾‘æ·»åŠ è¯¦ç»†æ³¨é‡Š
   - ç»Ÿä¸€çš„å‘½åè§„èŒƒ
   - å¸¸é‡å®šä¹‰æ¸…æ™°

4. **æ€§èƒ½ä¼˜åŒ–**
   - æœ€å°åŒ–å­è¿›ç¨‹è°ƒç”¨
   - ä¿æŒé«˜æ•ˆçš„æ‰§è¡Œé€Ÿåº¦

5. **å…³é”®è®¾è®¡å†³ç­–**
   - RFS é»˜è®¤ç¦ç”¨ï¼ˆè¯¦è§æ³¨é‡Šè¯´æ˜åŸå› ï¼‰
   - mlx5 é˜Ÿåˆ—æ•°ç‰¹æ®Šå¤„ç†ï¼ˆ/2ï¼‰
   - systemd ç¯å¢ƒè‡ªåŠ¨æ£€æµ‹
   - æ”¯æŒä½œä¸ºåº“æ–‡ä»¶ source
   - >64 CPU çš„æ©ç è®¡ç®—æ”¯æŒ
   - bonding åœºæ™¯çš„å»¶è¿Ÿä¿æŠ¤ï¼ˆ10 ç§’ï¼‰

## å¼€å‘è€…è¯´æ˜

### ä»£ç ç»“æ„

```
linux_ethernet_optimization.sh
â”œâ”€â”€ æ ¸å¿ƒé€»è¾‘ä¿æŠ¤æ³¨é‡Š
â”œâ”€â”€ ä¾èµ–æ£€æŸ¥å‡½æ•°
â”‚   â”œâ”€â”€ check_script_requirements()
â”‚   â”œâ”€â”€ check_root()
â”‚   â””â”€â”€ run_by_systemd()
â”œâ”€â”€ åŸºç¡€å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ _sysfs_read()
â”‚   â”œâ”€â”€ _sysfs_write()
â”‚   â””â”€â”€ _ethtool_extract_value()
â”œâ”€â”€ CPU Mask è®¡ç®—
â”‚   â”œâ”€â”€ generate_cpus_mask()      # æ”¯æŒ bash/bc/python3/calc fallback
â”‚   â””â”€â”€ format_cpumask()
â”œâ”€â”€ ç¡¬ä»¶æŸ¥è¯¢å‡½æ•°
â”‚   â”œâ”€â”€ get_ethernet_hardware_*()
â”‚   â””â”€â”€ get_ethernet_kernel_*()
â”œâ”€â”€ ä¼˜åŒ–å‡½æ•°ï¼ˆ6 å¯¹ï¼‰
â”‚   â”œâ”€â”€ check_ethernet_{rps,xps,rfs,queue,ringbuffer,irq_affinity}()
â”‚   â””â”€â”€ set_ethernet_*_to_optimum()
â”œâ”€â”€ è¿‡æ»¤ä¸ä¸»å¾ªç¯
â”‚   â”œâ”€â”€ get_filtered_ethernet_card_list()
â”‚   â””â”€â”€ main()
â””â”€â”€ è„šæœ¬å…¥å£ï¼ˆis_sourced æ£€æµ‹ï¼‰
```

### å¦‚ä½•æ‰©å±•

#### æ·»åŠ æ–°çš„ä¼˜åŒ–é¡¹

1. åˆ›å»º `check_ethernet_<new_feature>()` å‡½æ•°
2. åˆ›å»º `set_ethernet_<new_feature>_to_optimum()` å‡½æ•°
3. åœ¨ `main()` çš„ action åˆ—è¡¨ä¸­æ·»åŠ æ–°é¡¹
4. æ·»åŠ å‘½ä»¤è¡Œé€‰é¡¹è§£æ

#### æ·»åŠ æ–°çš„ç¡¬ä»¶æ”¯æŒ

1. åœ¨ `get_ethernet_kernel_queues_number()` ä¸­æ·»åŠ ç‰¹æ®Šå¤„ç†é€»è¾‘
2. åœ¨ IRQ æå–é€»è¾‘ä¸­æ·»åŠ æ–°çš„å‘½åæ¨¡å¼
3. æµ‹è¯•éªŒè¯

### æµ‹è¯•å»ºè®®

```bash
# 1. è¯­æ³•æ£€æŸ¥
shellcheck linux_ethernet_optimization.sh

# 2. å¹²è¿è¡Œæµ‹è¯•
sudo ./linux_ethernet_optimization.sh -n

# 3. å•é¡¹æµ‹è¯•
sudo ./linux_ethernet_optimization.sh -y -a queue

# 4. å¯¹æ¯”æµ‹è¯•ï¼ˆè®°å½•ä¼˜åŒ–å‰åçŠ¶æ€ï¼‰
ethtool -l eth0 > before.txt
sudo ./linux_ethernet_optimization.sh -y
ethtool -l eth0 > after.txt
diff before.txt after.txt
```

## è®¸å¯è¯

MIT License

Copyright (c) 2026 Network Optimization Project

ç‰¹æ­¤å…è´¹æˆäºˆä»»ä½•è·å¾—æœ¬è½¯ä»¶åŠç›¸å…³æ–‡æ¡£æ–‡ä»¶ï¼ˆ"è½¯ä»¶"ï¼‰å‰¯æœ¬çš„äººä¸å—é™åˆ¶åœ°å¤„ç½®è¯¥è½¯ä»¶çš„æƒåˆ©ï¼Œ
åŒ…æ‹¬ä½†ä¸é™äºä½¿ç”¨ã€å¤åˆ¶ã€ä¿®æ”¹ã€åˆå¹¶ã€å‘å¸ƒã€åˆ†å‘ã€å†è®¸å¯å’Œ/æˆ–é”€å”®è¯¥è½¯ä»¶å‰¯æœ¬çš„æƒåˆ©ï¼Œ
ä»¥åŠå…è®¸å‘å…¶æä¾›è½¯ä»¶çš„äººè¿™æ ·åšï¼Œä½†é¡»ç¬¦åˆä»¥ä¸‹æ¡ä»¶ï¼š

ä¸Šè¿°ç‰ˆæƒå£°æ˜å’Œæœ¬è®¸å¯å£°æ˜åº”åŒ…å«åœ¨è¯¥è½¯ä»¶çš„æ‰€æœ‰å‰¯æœ¬æˆ–ä¸»è¦éƒ¨åˆ†ä¸­ã€‚

æœ¬è½¯ä»¶æŒ‰"åŸæ ·"æä¾›ï¼Œä¸æä¾›ä»»ä½•å½¢å¼çš„æ˜ç¤ºæˆ–æš—ç¤ºæ‹…ä¿ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºé€‚é”€æ€§ã€
ç‰¹å®šç”¨é€”é€‚ç”¨æ€§å’Œéä¾µæƒæ€§çš„æ‹…ä¿ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œä½œè€…æˆ–ç‰ˆæƒæŒæœ‰äººå‡ä¸å¯¹ä»»ä½•ç´¢èµ”ã€
æŸå®³æˆ–å…¶ä»–è´£ä»»è´Ÿè´£ï¼Œæ— è®ºæ˜¯åœ¨åˆåŒè¯‰è®¼ã€ä¾µæƒè¡Œä¸ºè¿˜æ˜¯å…¶ä»–æ–¹é¢ï¼Œ
ç”±è½¯ä»¶æˆ–è½¯ä»¶çš„ä½¿ç”¨æˆ–å…¶ä»–äº¤æ˜“å¼•èµ·ã€äº§ç”Ÿæˆ–ä¸ä¹‹ç›¸å…³ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestã€‚

## ç›¸å…³é“¾æ¥

- Kernel æ–‡æ¡£ï¼š`man 7 cpuset`
- systemd æ–‡æ¡£ï¼š`man 5 systemd.link`, `man 5 systemd.service`
- RPS/RFS å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.kernel.org/doc/Documentation/networking/scaling.txt

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ Issue åé¦ˆã€‚
